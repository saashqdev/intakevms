# Instructions for creating new tables in a project using Alembic

This file provides auxiliary information when working on the project. 
For complete information on working with Alembic, please refer to the [official documentation](https://alembic.sqlalchemy.org/).

## Step 1: Creating an ORM model

After developing a new ORM model using SQLAlchemy, for example:

File: `intakevms/modules/block_device/adapters/orm.py`

```python
"""ORM models of the block device module"""

import uuid

from sqlalchemy import Table, Column, String, MetaData
from sqlalchemy.orm import registry
from sqlalchemy.dialects import postgresql

metadata = MetaData()
mapper_registry = registry(metadata=metadata)

iscsi_interfaces = Table(
    'iscsi_interfaces',
    mapper_registry.metadata,
    Column(
        'id',
        postgresql.UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    ),
    Column('inf_type', String(20)),
    Column('ip', String(40), unique=True),
    Column('port', String(20), nullable=True),
    Column('status', String(20)),
)


class ISCSIInterface:
    """ORM model for iscsi_interfaces table"""

    pass


def start_mappers() -> None:
    """Start mapping ORM models to tables on db for the block device module"""
    mapper_registry.map_imperatively(ISCSIInterface, iscsi_interfaces)
```

## Step 2: Adding a model to an Alembic configuration
In order for Alembic to track changes in the new model, it is necessary to import the corresponding ORM module into the script `intakevms/alembic/env.py` and add its metadata to target_metadata.

Add the following lines to the env.py script:

```python
from intakevms.modules.block_device.adapters import orm as orm_block_device
```
We also add the metadata of the new module to the target_metadata array:

```python
target_metadata = [
    ...,
    orm_block_device.mapper_registry.metadata,
]
```

## Step 3: Migration generation
To create a new migration using Alembic, you need to run the following command in the terminal, with the project virtual environment activated:

```bash
~/intakevms$ alembic revision -m "create_block_device" --rev-id 2 --autogenerate
```

- The -m flag is responsible for the name of the python script for creating and deleting the table.
- The --rev-id flag is for the migration number identifier. The project usually numbers them sequentially, starting with one. Accordingly, if the current migration id is, for example, 4, then we pass 5 to --rev-id.
- The --autogenerate flag ensures that Alembic generates a script for creating and deleting a table itself, checking against the orm.py files of the project. Without it, the functions inside the generated script will not be implemented and will contain pass in their body.

After the command is successfully executed, the migration file intakevms/alembic/versions/2_create_block_device.py will be created, which will contain all the changes in the ORM models specified in the target_metadata of the env.py file. In this case, the changes concern only the new table for the block device module.

It is important to ensure that the functions are generated correctly and contain the current changes associated with the table.

An example:
```python
"""create_block_device

Revision ID: 2
Revises: 1
Create Date: 2024-08-12 16:19:22.530565

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '2'
down_revision = '1'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('iscsi_interfaces',
    sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
    sa.Column('inf_type', sa.String(length=20), nullable=True),
    sa.Column('ip', sa.String(length=40), nullable=True),
    sa.Column('port', sa.String(length=20), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('ip')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('iscsi_interfaces')
    # ### end Alembic commands ###

```

## Step 4: Applying migration
To apply the new migration, run the command:

```bash
~/intakevms$ alembic upgrade head
```

This command will apply all the current changes to the database. Alembic will update the revision ID in the Alembic table and execute the script to create the new table.

## Important Notes

- **Adding a model to env.py:** When creating a new module, it is important to add the orm.py file to env.py immediately after creating it.. Only then can you run Alembic commands to generate and apply migrations.
- **Avoid creating tables manually:** Never create tables manually unless absolutely necessary. In case of table features, make sure that the database model is designed correctly. Manual creation of tables can lead to a discrepancy between the ORM model and the real database structure, which can cause errors when using Alembic further.
- **The final state of the new table is brought to one file:** During the development of the module, there is a need to add or remove fields. While the functionality is located and developed in a separate branch, the decision on how to change the table structure remains with the developer. But when preparing to merge with the main branches of the project, the developer must create a migration script from scratch (following this instruction), based on the final state of the orm model. And then in the final stage, create a pull request

Following these guidelines will help you avoid mistakes when working with migrations and ensure the integrity and relevance of your database structure.



